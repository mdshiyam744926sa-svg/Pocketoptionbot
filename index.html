<script>
document.addEventListener('DOMContentLoaded', function () {
    const tg = window.Telegram.WebApp;

    // --- DOM Elements ---
    const balanceDisplay = document.getElementById('balanceDisplay'),
          adCountDisplay = document.getElementById('adCountDisplay'),
          dailyAdCountDisplay = document.getElementById('dailyAdCountDisplay'),
          rewardedBtn = document.getElementById('rewardedBtn'),
          mainWithdrawBtn = document.getElementById('mainWithdrawBtn'),
          statusMessage = document.getElementById('statusMessage'),
          withdrawBalanceDisplay = document.getElementById('withdrawBalanceDisplay'),
          paymentAddressInput = document.getElementById('paymentAddress'),
          finalWithdrawBtn = document.getElementById('finalWithdrawBtn'),
          referralLinkDisplay = document.getElementById('referralLink'),
          referralCountDisplay = document.getElementById('referralCountDisplay'),
          referralBonusDisplay = document.getElementById('referralBonusDisplay'),
          adminPanel = document.getElementById('adminPanel'),
          userInfoDisplay = document.getElementById('userInfo');

    // --- App Constants ---
    const ADMIN_ID = 7213428627; 
    const BOT_USERNAME = 'Pockett_option_bot'; 
    const WEBAPP_NAME = 'Pockett_option_bot';  
    const WITHDRAW_THRESHOLD = 10;      
    const AD_REWARD_CENTS = 1;          
    const REFERRAL_BONUS_USDT = 0.5;    
    const DAILY_AD_LIMIT = 1000;

    // --- App State ---
    let state = {
        balanceInCents: 0,
        totalAdCount: 0,
        dailyAdCount: 0,
        lastAdDate: null,
        referralCount: 0 
    };

    // ---- State Management ----
    function getTodayDateString() { return new Date().toISOString().split('T')[0]; }
    function loadState() {
        try {
            const savedState = JSON.parse(localStorage.getItem('earningAppUSDTState'));
            if (savedState) { state = { ...state, ...savedState }; }
        } catch (e) { console.error("Could not load state", e); }
        if (state.lastAdDate !== getTodayDateString()) {
            state.dailyAdCount = 0;
            state.lastAdDate = getTodayDateString();
            saveState();
        }
    }
    function saveState() { localStorage.setItem('earningAppUSDTState', JSON.stringify(state)); }

    // ---- UI Updates & View Management ----
    function updateUI() {
        const balanceInDogs = (state.balanceInCents / 100).toFixed(2);

        // Home & Withdraw Views
        balanceDisplay.textContent = `Dogs ${balanceInDogs}`;
        adCountDisplay.textContent = state.totalAdCount;
        dailyAdCountDisplay.textContent = `${state.dailyAdCount} / ${DAILY_AD_LIMIT}`;
        withdrawBalanceDisplay.textContent = `Dogs ${balanceInDogs}`;

        // Referral View
        referralCountDisplay.textContent = state.referralCount;
        const referralBonus = (state.referralCount * REFERRAL_BONUS_USDT).toFixed(2);
        referralBonusDisplay.textContent = `Dogs ${referralBonus}`;

        // Button States
        const isWithdrawalPossible = parseFloat(balanceInDogs) >= WITHDRAW_THRESHOLD;
        mainWithdrawBtn.disabled = !isWithdrawalPossible;
        mainWithdrawBtn.textContent = isWithdrawalPossible ? 'Go to Withdraw' : `Reach ${WITHDRAW_THRESHOLD.toFixed(2)} Dogs to Withdraw`;
        finalWithdrawBtn.disabled = !isWithdrawalPossible;
        finalWithdrawBtn.textContent = isWithdrawalPossible ? `Withdraw ${balanceInDogs} Dogs` : `Minimum ${WITHDRAW_THRESHOLD.toFixed(2)} Dogs required`;

        const adLimitReached = state.dailyAdCount >= DAILY_AD_LIMIT;
        rewardedBtn.disabled = adLimitReached;
        rewardedBtn.textContent = adLimitReached ? 'Daily Limit Reached' : 'Watch Ad (+0.01 Dogs)';
    }

    function showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
        document.getElementById(viewId).style.display = 'block';
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        const activeNavId = { 'home-view': 'navHome', 'withdraw-view': 'navWithdraw', 'referral-view': 'navRefer' }[viewId];
        if(activeNavId) document.getElementById(activeNavId).classList.add('active');
    }

    let statusTimeout;
    function showStatus(message, type, duration = 4000) {
        clearTimeout(statusTimeout);
        statusMessage.textContent = message;
        statusMessage.className = `status-message ${type}`;
        statusTimeout = setTimeout(() => { statusMessage.style.display = 'none'; }, duration);
    }

    // ---- Ad Handling ----
    function handleAdSuccess() {
        state.totalAdCount++;
        state.dailyAdCount++;
        state.lastAdDate = getTodayDateString();
        state.balanceInCents += AD_REWARD_CENTS;

        showStatus(`Success! +${(AD_REWARD_CENTS / 100).toFixed(2)} Dogs has been added.`, 'success');
        saveState();
        updateUI();
    }
    function handleAdError(error) {
        console.error('Ad Error:', error);
        showStatus('Failed to load ad. Please try again.', 'error');
    }

    function requestAd() {
        if (state.dailyAdCount >= DAILY_AD_LIMIT) {
            showStatus("You've reached the daily ad limit.", 'error');
            return;
        }
        showStatus('Loading ad, please wait...', 'info');
        Promise.resolve(show_9459352()).then(handleAdSuccess).catch(handleAdError);
    }

    // ---- Withdrawal ----
    function handleWithdrawal() {
        const balanceInDogs = (state.balanceInCents / 100).toFixed(2);
        const walletAddress = paymentAddressInput.value.trim();
        if (parseFloat(balanceInDogs) < WITHDRAW_THRESHOLD) {
            showStatus(`You need at least ${WITHDRAW_THRESHOLD.toFixed(2)} Dogs to withdraw.`, 'error');
            return;
        }
        if (!walletAddress.startsWith('T') || walletAddress.length < 34) {
            showStatus('Please enter a valid Dogs (TRC20) wallet address.', 'error');
            return;
        }
        const user = tg.initDataUnsafe.user;
        const message = `--- Withdrawal Request ---\n\nUser ID: ${user.id}\nName: ${user.first_name} ${user.last_name || ''}\nUsername: @${user.username || 'N/A'}\n\nAmount: ${balanceInDogs} Dogs\nWallet Address: ${walletAddress}`;
        tg.sendData(message);
        showStatus('Your withdrawal request has been sent for review.', 'success');
        state.balanceInCents = 0;
        saveState();
        updateUI();
        paymentAddressInput.value = '';
        showView('home-view');
    }

    // ---- Referral ----
    function generateReferralLink() {
        const user = tg.initDataUnsafe.user;
        if (user && user.id && BOT_USERNAME !== 'YourBotUsername' && WEBAPP_NAME !== 'YourWebAppName') {
            referralLinkDisplay.textContent = `https://t.me/${BOT_USERNAME}/${WEBAPP_NAME}?startapp=ref${user.id}`;
        } else {
            referralLinkDisplay.textContent = "Referral link cannot be generated. Configure bot info in the script.";
            referralLinkDisplay.style.color = "var(--warning-color)";
            referralLinkDisplay.style.cursor = "default";
        }
    }

    function handleReferralStart() {
        if (tg.initDataUnsafe.start_param) {
            const referrerId = tg.initDataUnsafe.start_param.replace('ref', '');
            console.log("App started with referral parameter. Referrer ID:", referrerId);
            showStatus('Welcome! You joined via a referral link.', 'success', 5000);
        }
    }

    // ---- Event Listeners ----
    rewardedBtn.addEventListener('click', () => requestAd());
    finalWithdrawBtn.addEventListener('click', handleWithdrawal);
    document.getElementById('navHome').addEventListener('click', () => showView('home-view'));
    document.getElementById('navWithdraw').addEventListener('click', () => showView('withdraw-view'));
    document.getElementById('navRefer').addEventListener('click', () => showView('referral-view'));
    mainWithdrawBtn.addEventListener('click', () => showView('withdraw-view'));
    referralLinkDisplay.addEventListener('click', () => {
        if(navigator.clipboard && referralLinkDisplay.textContent.startsWith('https://')) {
            navigator.clipboard.writeText(referralLinkDisplay.textContent)
                .then(() => showStatus('Referral link copied!', 'success'))
                .catch(() => showStatus('Could not copy link.', 'error'));
        }
    });

    // ---- Initialization ----
    function initializeApp() {
        tg.ready();
        tg.expand();
        loadState();
        updateUI();
        generateReferralLink();
        handleReferralStart();
        const user = tg.initDataUnsafe.user;
        if (user && user.id === ADMIN_ID) {
            adminPanel.style.display = 'block';
            userInfoDisplay.textContent = `Welcome, Admin! User: ${user.first_name} (@${user.username || 'N/A'}), ID: ${user.id}`;
        }
    }

    initializeApp();
});
</script>
